name: E2ETest

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  model-registry-e2e:
    runs-on:
      - self-hosted
    timeout-minutes: 10
    steps:
      - name: Set up Go 1.14
        uses: actions/setup-go@v1
        with:
           go-version: 1.14.7
        id: go
      - uses: actions/checkout@v2
        with:
         path: src/github.com/kleveross/klever-model-registry
      - name: setup env
        run: |
          cd src/github.com/kleveross/klever-model-registry
          pwd
          go env
          echo "::set-env name=GOPATH::$(go env GOPATH):$GITHUB_WORKSPACE"
          echo "::add-path::$(go env GOPATH)/bin"
      - name: install
        env:
          HARBOR_DOMAIN: ${{ secrets.HARBOR_DOMAIN }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          cd src/github.com/kleveross/klever-model-registry
          make build
          ./bin/klever-model-registry --registry-kube-config /var/run/kubernetes/admin.kubeconfig --registry-domain $HARBOR_DOMAIN --registry-username $HARBOR_USERNAME --registry-password $HARBOR_PASSWORD --port 8888 &
          curl localhost:8888/api/v1alpha1/namespaces/default/modeljobs
